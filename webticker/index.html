<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Real-time updates: BTC/USD</title>
  <link href="examples.css" rel="stylesheet" type="text/css">
  <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
  <script language="javascript" type="text/javascript" src="js/jquery.js"></script>
  <script language="javascript" type="text/javascript" src="js/jquery.flot.js"></script>
  <script language="javascript" type="text/javascript" src="js/jquery.flot.time.js"></script>
  <script language="javascript" type="text/javascript" src="js/socket.io.js"></script>
  <script type="text/javascript">

	$(function() {

	    var totalPoints = 60*30;

            var plot = $.plot("#placeholder", [
                { data: [],
		  label: "Average" 
		},
                { data: [],
		  label: "Buy" 
		},
                { data: [],
		  label: "Sell" 
		}/*,
                { data: [],
		  label: "Volume", 
		  yaxis: 2
		}*/
            ], {
                xaxes: [ 
		    { mode: "time",
		      show: true
		    } 
		],
                yaxes: [
		    { },
		    {
                    // align if we are to the right
                    alignTicksWithAxis: 1,//position == "right" ? 1 : null,
                    position: "right",
                    } 
		],
                legend: { position: "nw" },
		series: {
		    shadowSize: 0 // Drawing is faster without shadows
		}
            });

	    // Add the Flot version string to the footer
	    $("#footer").prepend("Flot " + $.plot.version + " &ndash; ");

	    var conn = io.connect('https://socketio.mtgox.com/mtgox');
	    conn.on('connect', function(msg) {
		console.debug('Connected.');
	    });

	    conn.on('disconnect', function(msg) {
		console.debug('Disconnected.');
		conn = io.connect('https://socketio.mtgox.com/mtgox');
	    });

	    conn.on('error', function(msg) {
		console.debug('Error. ' + msg);
		conn = io.connect('https://socketio.mtgox.com/mtgox');
	    });

	    conn.on('message', function(msg) {
		//console.debug(msg);
		/*if(msg.op == 'private' && msg.private == 'depth')
		{
		    var avg_data = plot.getData()[0].data;
		    var buy_data = plot.getData()[1].data;
		    var sell_data = plot.getData()[2].data;
		    var vol_data = plot.getData()[3].data;

		    if(vol_data.length == totalPoints)
		    {
			vol_data = vol_data.slice(1);
		    }
		    var now = Math.round(msg.depth.now/1000);
		    //vol_data.push([now, msg.depth.total_volume_int]);
		    //$("#vol").text(msg.depth.total_volume_int);
		    vol_data.push([now, msg.depth.volume]);
		    $("#vol").text(msg.depth.volume);


		    plot.setData([{ data: avg_data, label: "Average" },
				  { data: buy_data, label: "Buy" },
				  { data: sell_data, label: "Sell"},
				  { data: vol_data, label: "Total volume", yaxis: 2}
				 ]);
		    //plot.setupGrid();
		    //plot.draw();
		}
		else*/ if(msg.op == 'private' && msg.private == 'ticker')
		{
		    //console.debug(plot.getData()[0].data)
		    var avg_data = plot.getData()[0].data;
		    var buy_data = plot.getData()[1].data;
		    var sell_data = plot.getData()[2].data;
		    //var vol_data = plot.getData()[3].data;

		    if(avg_data.length == totalPoints)
		    {
			avg_data = avg_data.slice(1);
			buy_data = buy_data.slice(1);
			sell_data = sell_data.slice(1);
		    }
		    var now = Math.round(msg.ticker.now/1000);
		    avg_data.push([now, msg.ticker.avg.value]);
		    buy_data.push([now, msg.ticker.buy.value]);
		    sell_data.push([now, msg.ticker.sell.value]);
		    $("#avg").text(msg.ticker.avg.value);
		    $("#buy").text(msg.ticker.buy.value);
		    $("#sel").text(msg.ticker.sell.value);

		    plot.setData([{ data: avg_data, label: "Average" },
				  { data: buy_data, label: "Buy" },
				  { data: sell_data, label: "Sell"},
				  //{ data: vol_data, label: "Total volume", yaxis: 2}
				 ]);

		    plot.setupGrid();
		    plot.draw();
		}
	    });

	});

	</script>
</head>
<body>

  <div id="header">
    <h2>Real-time updates: BTC/USD</h2>
  </div>

  <center> <font size="1">
    <table>
    <tr>
    <td>Average:</td><td></td><td><b><div id="avg">0.0</div></b></td>
    <td>Buy:</td><td></td><td><b><div id="buy">0.0</div></b></td>
    <td>Sell:</td><td></td><td><b><div id="sel">0.0</div></b></td>
    <td>Volume:</td><td></td><td><b><div id="vol">0.0</div></b></td>
    </tr>
    </table>
  </font> </center>
  <div id="content">

    <div class="demo-container">
      <div id="placeholder" class="demo-placeholder"></div>
    </div>
  </div>
</body>
</html>
