<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Flot Examples: Real-time updates</title>
	<link href="examples.css" rel="stylesheet" type="text/css">
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
	<script language="javascript" type="text/javascript" src="js/jquery.js"></script>
	<script language="javascript" type="text/javascript" src="js/jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="js/jquery.flot.time.js"></script>
	<script language="javascript" type="text/javascript" src="js/socket.io.js"></script>
	<script type="text/javascript">

	$(function() {

	    var totalPoints = 60*2;

            var plot = $.plot("#placeholder", [
                { data: [],//function(){var d = []; for(i = 0; i < totalPoints; i++) d.push([i, 0.0]); return d;}(), 
		  label: "BTC/USD" 
		},
                { data: [],//function(){var d = []; for(i = 0; i < totalPoints; i++) d.push([i, 0.0]); return d;}(), 
		  label: "Change rate", 
		  yaxis: 2
		}
            ], {
                xaxes: [ 
		    { mode: "time",
		      show: true
		    } 
		],
                yaxes: [
		    { },
		    {
                    // align if we are to the right
                    alignTicksWithAxis: 1,//position == "right" ? 1 : null,
                    position: "right",
                    } 
		],
                legend: { position: "nw" },
		series: {
		    shadowSize: 0 // Drawing is faster without shadows
		}
            });

	    // Add the Flot version string to the footer
	    $("#footer").prepend("Flot " + $.plot.version + " &ndash; ");

	    var conn = io.connect('https://socketio.mtgox.com/mtgox');
	    conn.on('connect', function(msg) {
		console.debug('Connected.');
	    });

	    conn.on('disconnect', function(msg) {
		console.debug('Disconnected.');
		conn = io.connect('https://socketio.mtgox.com/mtgox');
	    });

	    conn.on('error', function(msg) {
		console.debug('Error. ' + msg);
		conn = io.connect('https://socketio.mtgox.com/mtgox');
	    });

	    conn.on('message', function(msg) {
		if(msg.op == 'private' && msg.private == 'ticker')
		{
		    var graph_data0 = plot.getData()[0].data
		    var graph_data1 = plot.getData()[1].data

		    if(graph_data0.length == totalPoints)
		    {
			graph_data0 = graph_data0.slice(1);
			graph_data1 = graph_data1.slice(1);
		    }
		    //console.debug(Math.round(msg.ticker.now/1000), msg.ticker.avg.value);

		    graph_data0.push([Math.round(msg.ticker.now/1000), msg.ticker.avg.value]);
		    if(graph_data0.length > 1)
			graph_data1.push([Math.round(msg.ticker.now/1000), 
					  graph_data0[graph_data0.length-1][1] - graph_data0[graph_data0.length-2][1]]);
		    else
			graph_data1.push([Math.round(msg.ticker.now/1000), 0.0]);

		    //console.debug(graph_data0); console.debug(graph_data1);
		    plot.setData([{ data: graph_data0, label: "BTC/USD" }, 
				  { data: graph_data1, label: "Change rate", yaxis: 2}
				 ]);

		    plot.setupGrid();
		    plot.draw();
		}
	    });

	});

	</script>
</head>
<body>

    <div id="header">
      <h2>Real-time updates</h2>
    </div>

    <div id="content">

      <div class="demo-container">
	<div id="placeholder" class="demo-placeholder"></div>
      </div>
    </div>
</body>
</html>
